# iMac HARPA Browser Node Configuration Guide
**Symphony Smart Homes — Intel iMac Automation Nodes**

This guide covers setting up Chrome and HARPA AI on both Intel iMacs after running the setup scripts.

---

## Overview

There are two Intel iMacs in the Symphony Smart Homes AI network:

| Machine | RAM | Role | Setup Script |
|---|---|---|---|
| 64GB iMac | 64GB | Primary: Ollama worker + HARPA automation | `setup_imac_harpa.sh` |
| 8GB iMac | 8GB | Secondary: HARPA browser-only node | `setup_imac_browser_only.sh` |

Both iMacs run Chrome with the HARPA AI extension to automate D-Tools Cloud.

---

## Step 1: Install Chrome

1. Download Chrome: https://www.google.com/chrome/
2. Install and open Chrome
3. Do NOT sign into your personal Google account in Chrome's main profile
   (use a dedicated automation profile instead — see Step 2)

---

## Step 2: Create a dedicated Chrome automation profile

This keeps the automation session separate from personal browsing.

1. In Chrome, click your profile icon (top right)
2. Click **Add** or **+** to create a new profile
3. Name it: `Symphony Automation`
4. Do not sync to a Google account (automation profiles should be standalone)
5. All HARPA setup and D-Tools login happens in this profile

---

## Step 3: Install HARPA AI extension

1. In the `Symphony Automation` Chrome profile:
2. Go to: https://chrome.google.com/webstore/detail/harpa-ai/eanggfilgoajaocelnaflolkadkeghjp
3. Click **Add to Chrome** → **Add extension**
4. HARPA icon appears in toolbar

---

## Step 4: Create a HARPA account and activate

1. Click the HARPA icon in Chrome toolbar
2. Follow the setup wizard to create an account (or sign in if you have one)
3. Activate your plan (HARPA Grid requires a Pro or higher plan)
4. Note your account email for reference

---

## Step 5: Enable HARPA Grid

HARPA Grid is what allows Bob (Mac Mini M4) to send commands to HARPA over HTTP.

1. In Chrome, open HARPA sidebar (click HARPA icon)
2. Click the **Settings** gear icon
3. Navigate to **Grid** or **API** section
4. Enable Grid mode: toggle ON
5. Note your Grid settings:
   - **Grid URL**: typically `http://localhost:8765` or similar
   - **API Key**: generated by HARPA — copy this carefully
   - **Port**: default 8765 (confirm in settings)

6. Add the Grid API key to Bob's bridge configuration:
   ```bash
   # On Mac Mini M4 (Bob):
   export HARPA_GRID_API_KEY="your-api-key-here"
   # Or add to ~/.zprofile:
   echo 'export HARPA_GRID_API_KEY="your-api-key-here"' >> ~/.zprofile
   ```

---

## Step 6: Import D-Tools commands into HARPA

1. In Chrome HARPA sidebar, click **Commands**
2. Click **Import** or the ⋮ menu → **Import commands**
3. Navigate to: `~/AI-Server/setup/harpa/harpa_dtools_commands.json`
4. Select the file and confirm import
5. Verify all 6 commands appear:
   - D-Tools: Create Project
   - D-Tools: Import Equipment CSV
   - D-Tools: Get Project Status
   - D-Tools: Export Proposal
   - D-Tools: Update Project Phase
   - D-Tools: Search Projects

---

## Step 7: Log into D-Tools Cloud

1. In the `Symphony Automation` Chrome profile, navigate to:
   https://portal.d-tools.com
2. Log in with Symphony Smart Homes credentials
3. Check **Remember me** or **Stay signed in**
4. Verify you can see the projects list

HARPA will use this browser session for all automation. The session should stay
active as long as the Chrome profile is open and you don't log out.

---

## Step 8: Keep Chrome open and signed in

For automation to work:
- Chrome must be **running** (not just installed) on the iMac
- The `Symphony Automation` profile must be **open** (not hidden/minimized is OK)
- D-Tools must be **logged in** in that profile
- HARPA must be **active** (HARPA icon visible in toolbar)

### Auto-launch Chrome on login

Add Chrome to Login Items:
1. System Preferences → Users & Groups → Login Items
2. Click **+** and add Google Chrome
3. Optional: Add a shell script to open Chrome with the automation profile:
   ```bash
   # ~/Library/Scripts/launch_chrome_automation.sh
   #!/bin/bash
   open -a "Google Chrome" --args \
     --profile-directory="Profile 2"  # or whatever profile number Symphony Automation is
   ```

To find your profile directory name:
- Open Chrome → Settings → About Chrome
- Or check: `ls ~/Library/Application\ Support/Google/Chrome/`

---

## Step 9: Configure Bob's bridge with iMac IP

On the **64GB iMac**, find the local IP:
```bash
ipconfig getifaddr en1  # Ethernet (preferred)
ipconfig getifaddr en0  # Wi-Fi fallback
```

On the **Mac Mini M4 (Bob)**, update the bridge configuration:
```bash
# Set environment variable
export HARPA_GRID_URL="http://[IMAC_IP]:8765"

# Or add to ~/.zprofile for persistence:
echo 'export HARPA_GRID_URL="http://[IMAC_IP]:8765"' >> ~/.zprofile
```

Replace `[IMAC_IP]` with the actual IP address.

---

## Step 10: Test the full automation chain

On the **Mac Mini M4 (Bob)**:
```bash
# 1. Start the bridge
python3 ~/AI-Server/setup/harpa/bob_harpa_bridge.py &

# 2. Check bridge health
curl http://localhost:9090/health

# 3. Check HARPA node status
curl http://localhost:9090/status
# Expected: {"bridge": "running", "harpa_node": "available"}

# 4. Test D-Tools search
curl -X POST http://localhost:9090/automation/search_projects \
  -H 'Content-Type: application/json' \
  -d '{"search_term": "test"}'
```

If HARPA node shows `"unavailable"`, check:
- Is Chrome open on the iMac?
- Is HARPA Grid enabled?
- Is the iMac IP correct in the bridge config?
- Is port 8765 accessible? (check macOS firewall)

---

## macOS Firewall Note

For the Mac Mini to reach HARPA Grid on the iMac, port 8765 must be accessible:

1. On the iMac: System Preferences → Security & Privacy → Firewall
2. Click **Firewall Options**
3. Find Google Chrome in the list
4. Set to **Allow incoming connections**

Or temporarily disable the firewall for testing.

---

## Maintaining the Setup

| Task | Frequency | How |
|---|---|---|
| Keep Chrome open | Always | Login item or reminder |
| Renew D-Tools session | If expired | Re-login to D-Tools in Chrome |
| Update HARPA commands | When D-Tools UI changes | Re-import JSON |
| Check bridge is running | Weekly | `curl http://localhost:9090/health` |
